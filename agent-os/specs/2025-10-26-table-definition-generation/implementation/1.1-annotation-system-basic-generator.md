# Task 1.1: Annotation System & Basic Generator

## Overview
**Task Reference:** Task #1.1 from `/Users/fabier/Documents/code/surrealdartb/agent-os/specs/2025-10-26-table-definition-generation/tasks.md`
**Implemented By:** database-engineer
**Date:** 2025-10-26
**Status:** ✅ Complete

### Task Description
Implement the foundational annotation system and build_runner generator infrastructure for automatic SurrealDB table definition generation. This includes creating annotation classes (@SurrealTable, @SurrealField, @JsonField), setting up the build_runner infrastructure with generator configuration, and implementing the annotation parser that can extract metadata from annotated Dart classes.

## Implementation Summary

This implementation establishes the foundation for automatic table definition generation using Dart annotations and the build_runner code generation system. The solution follows established patterns from the json_serializable package, using const constructors for annotations and the GeneratorForAnnotation pattern for processing annotated classes.

The annotation system uses three primary decorators: @SurrealTable for marking classes as database tables, @SurrealField for specifying field-level schema metadata (type, default values, constraints, indexing, and vector dimensions), and @JsonField for marking fields that require JSON serialization. The generator infrastructure leverages the analyzer package to parse annotations at build time and validate that table/field names follow SurrealDB conventions.

A critical implementation decision was to rename the `assert` parameter to `assertClause` in the @SurrealField annotation, as `assert` is a reserved keyword in Dart. This ensures that the annotation API is both legal and idiomatic while maintaining clarity about its purpose (generating SurrealQL ASSERT clauses).

## Files Changed/Created

### New Files
- `/Users/fabier/Documents/code/surrealdartb/lib/src/schema/annotations.dart` - Defines the three annotation classes (SurrealTable, SurrealField, JsonField) with comprehensive documentation and usage examples
- `/Users/fabier/Documents/code/surrealdartb/lib/generator/surreal_table_generator.dart` - Implements the build_runner generator that processes @SurrealTable annotations and creates TableDefinition objects
- `/Users/fabier/Documents/code/surrealdartb/build.yaml` - Configures the build_runner to use our generator and specifies part file generation pattern (.surreal.dart)
- `/Users/fabier/Documents/code/surrealdartb/test/schema/annotation_test.dart` - Contains 11 focused tests validating annotation functionality, const constructors, and parameter handling

### Modified Files
- `/Users/fabier/Documents/code/surrealdartb/pubspec.yaml` - Added build_runner, source_gen, and analyzer dependencies for code generation infrastructure
- `/Users/fabier/Documents/code/surrealdartb/agent-os/specs/2025-10-26-table-definition-generation/tasks.md` - Marked tasks 1.1.0 through 1.1.5 as complete

### Deleted Files
None - this is new functionality with no deprecated code to remove.

## Key Implementation Details

### Annotation Classes
**Location:** `/Users/fabier/Documents/code/surrealdartb/lib/src/schema/annotations.dart`

Implemented three annotation classes following Dart best practices:

1. **SurrealTable** - Marks a class as a database table with a required `tableName` parameter
2. **SurrealField** - Comprehensive field metadata annotation with:
   - `type` (required): SurrealType specifying the database type
   - `defaultValue`: Default value for the field in the database schema
   - `assertClause`: SurrealQL validation expression (renamed from `assert` to avoid keyword conflict)
   - `indexed`: Boolean flag to create an index on this field
   - `dimensions`: Vector dimensions for vector type fields
3. **JsonField** - Marker annotation for JSON serialization support

All annotations use const constructors for compile-time evaluation and follow the immutable value object pattern.

**Rationale:** The annotation API design mirrors json_serializable patterns for developer familiarity while providing SurrealDB-specific parameters. The use of `assertClause` instead of `assert` maintains API clarity while avoiding Dart keyword conflicts.

### Build Runner Infrastructure
**Location:** `/Users/fabier/Documents/code/surrealdartb/build.yaml` and `/Users/fabier/Documents/code/surrealdartb/lib/generator/surreal_table_generator.dart`

Configured build_runner to:
- Generate `.surreal.dart` part files (following json_serializable conventions)
- Auto-apply to all dependents
- Build to source (generate files alongside original files)

The generator class extends `GeneratorForAnnotation<SurrealTable>` and implements:
- Table name extraction and validation (must be lowercase, alphanumeric, underscore, starting with letter)
- Field annotation parsing using TypeChecker from source_gen
- Nullable type detection using analyzer's NullabilitySuffix
- Error generation with InvalidGenerationSourceError for validation failures

**Rationale:** Following the GeneratorForAnnotation pattern ensures compatibility with the Dart build system and provides excellent error messages during code generation. The SharedPartBuilder pattern allows multiple generators to work together in the future.

### Annotation Parser
**Location:** `/Users/fabier/Documents/code/surrealdartb/lib/generator/surreal_table_generator.dart`

The parser implements several validation and extraction steps:

1. **Class Validation:** Ensures @SurrealTable is only applied to classes
2. **Table Name Validation:** Checks that table names match pattern `[a-z][a-z0-9_]*`
3. **Field Extraction:** Uses TypeChecker to find @SurrealField annotations
4. **Metadata Extraction:** Reads all annotation parameters using ConstantReader
5. **Nullable Detection:** Identifies nullable types (String? vs String) for optional field generation
6. **Minimum Field Requirement:** Ensures at least one @SurrealField exists per table

**Rationale:** Early validation at generation time provides immediate feedback to developers, preventing runtime errors. The use of ConstantReader provides type-safe access to annotation parameters.

## Database Changes (if applicable)

No database changes in this phase - this implementation focuses on the code generation infrastructure. Database schema changes will be handled by the migration system in later phases.

## Dependencies (if applicable)

### New Dependencies Added
- `build: ^2.4.0` - Core build system functionality
- `source_gen: ^1.4.0` - Source code generation utilities including GeneratorForAnnotation
- `analyzer: ^6.0.0` - Dart analyzer for AST inspection and type checking
- `build_runner: ^2.4.0` (dev_dependencies) - Build system runner for code generation

### Configuration Changes
- Created `/Users/fabier/Documents/code/surrealdartb/build.yaml` with generator configuration
- Added `lib/generator/` directory to package structure for generator code

## Testing

### Test Files Created/Updated
- `/Users/fabier/Documents/code/surrealdartb/test/schema/annotation_test.dart` - Comprehensive test suite with 11 tests

### Test Coverage

**Unit tests:** ✅ Complete
- SurrealTable annotation creation and const constructor behavior (2 tests)
- SurrealField annotation with required and optional parameters (4 tests)
- JsonField annotation creation and const constructor (2 tests)
- Annotation validation and parameter defaults (3 tests)

**Integration tests:** ⚠️ Partial - Code generation integration tests will be added in Task 1.2 when type mapping is implemented

**Edge cases covered:**
- Empty table names (validation at generation time, not construction)
- Missing required parameters (enforced by Dart type system)
- Const constructor identity (verifies compile-time evaluation)
- Default parameter values (indexed defaults to false)
- Vector types with dimensions parameter
- All SurrealField parameters together

### Manual Testing Performed

1. **Dependency Installation:** Ran `dart pub get` successfully with all new dependencies
2. **Code Formatting:** Verified all code passes `dart format` without issues
3. **Test Execution:** All 11 annotation tests pass cleanly:
   ```
   dart test test/schema/annotation_test.dart
   00:00 +11: All tests passed!
   ```
4. **Compilation Check:** Verified annotations can be imported and used in other files without errors

## User Standards & Preferences Compliance

### /Users/fabier/Documents/code/surrealdartb/agent-os/standards/global/coding-style.md

**How Your Implementation Complies:**

The implementation strictly follows Effective Dart guidelines with:
- PascalCase for class names (SurrealTable, SurrealField, JsonField)
- camelCase for parameters (tableName, defaultValue, assertClause, indexed, dimensions)
- snake_case for file names (surreal_table_generator.dart, annotation_test.dart)
- Const constructors for all annotation classes ensuring compile-time evaluation
- Descriptive names that reveal intent (assertClause, not assert; dimensions, not dims)
- Comprehensive dartdoc documentation with usage examples
- Line length kept under 80 characters
- Final by default for all fields in annotation classes

**Deviations (if any):** None - full compliance with coding style standards.

### /Users/fabier/Documents/code/surrealdartb/agent-os/standards/global/conventions.md

**How Your Implementation Complies:**

Followed Dart package conventions precisely:
- Annotations placed in `lib/src/schema/` (implementation details)
- Generator placed in `lib/generator/` (standard build_runner pattern)
- Comprehensive dartdoc comments on all public APIs
- Updated pubspec.yaml with appropriate versioning for dependencies
- Used semantic versioning compatible ranges (^2.4.0, etc.)
- All code is soundly null-safe with proper nullable type annotations (String?, int?)
- No `!` operators used (none needed in annotation definitions)

**Deviations (if any):** None - full compliance with package conventions. Note that CHANGELOG.md will be updated in Task 6.3.6 as per the specification.

### /Users/fabier/Documents/code/surrealdartb/agent-os/standards/global/error-handling.md

**How Your Implementation Complies:**

Error handling follows established patterns:
- Used `InvalidGenerationSourceError` from source_gen for build-time errors
- Provided clear, actionable error messages (e.g., "table name must be a valid identifier: lowercase letters, numbers, underscores, starting with a letter")
- Included context in error messages (shows the invalid table name that failed validation)
- Validation happens at appropriate time (generation time for schema validation, compile-time for parameter types)

**Deviations (if any):** None - error handling aligns with standards.

### /Users/fabier/Documents/code/surrealdartb/agent-os/standards/testing/test-writing.md

**How Your Implementation Complies:**

Test implementation follows the testing standards:
- Used Arrange-Act-Assert pattern consistently across all 11 tests
- Descriptive test names clearly indicate scenario and expected outcome
- Tests are independent with no shared state
- Focused on testing the annotation classes in isolation (unit tests)
- Fast execution (all 11 tests complete in under 1 second)
- Proper test organization with logical grouping (SurrealTable, SurrealField, JsonField, Validation)

**Deviations (if any):** None - testing approach aligns fully with standards.

## Integration Points (if applicable)

### APIs/Endpoints
Not applicable - this is a build-time code generation system with no runtime API endpoints.

### External Services
- **build_runner** - Dart's official code generation framework
- **analyzer package** - Dart analyzer API for AST inspection

### Internal Dependencies

This implementation integrates with:
- `lib/src/schema/surreal_types.dart` - SurrealType hierarchy used in @SurrealField type parameter
- `lib/src/types/vector_value.dart` - VectorFormat enum referenced in annotation examples
- Future integration point: `lib/src/schema/table_structure.dart` - TableStructure will be generated by this system

## Known Issues & Limitations

### Issues
None currently - all 11 tests pass and code generation infrastructure is set up correctly.

### Limitations

1. **Placeholder Type Expression Generation**
   - Description: The `_generateTypeExpression()` and `_generateDefaultValue()` methods in the generator currently return placeholders
   - Reason: Type mapping logic will be implemented in Task 1.2
   - Future Consideration: Task 1.2 will implement full type mapping from Dart types to SurrealDB types

2. **No Vector Dimension Validation**
   - Description: The generator extracts the dimensions parameter but doesn't validate it matches the VectorType dimensions
   - Reason: Validation will be added in Task 2.2 with full vector type support
   - Future Consideration: Task 2.2 will add cross-validation between type and dimensions parameters

3. **Part File Generation Not Yet Functional**
   - Description: While infrastructure is in place, actual .surreal.dart file generation awaits type mapper
   - Reason: Cannot generate complete TableDefinition code without type mapping
   - Future Consideration: Task 1.2 will enable full code generation with working build_runner builds

## Performance Considerations

The annotation system has zero runtime overhead as all processing happens at build time via build_runner. The use of const constructors enables compile-time evaluation, and the GeneratorForAnnotation pattern efficiently processes only annotated classes rather than scanning all source code.

Future performance will depend on the complexity of type mapping (Task 1.2), but the current foundation is optimized for fast builds.

## Security Considerations

Build-time code generation has minimal security implications. The primary consideration is ensuring generated code doesn't introduce vulnerabilities:

- Table name validation prevents injection attacks via regex validation
- Field names are not currently validated but will be in future tasks
- All generated code will be visible in source control for review
- No sensitive data is processed or stored in annotations

## Dependencies for Other Tasks

This task is a dependency for all subsequent tasks in the Table Definition Generation feature:

- **Task 1.2** (Basic Type Mapping & TableDefinition Generation) - Directly depends on this annotation system
- **Task 2.1** (Collection & Nested Object Types) - Will extend the annotation parser for nested types
- **Task 2.2** (Vector Types & Schema Constraints) - Will use the dimensions parameter defined here
- **All Migration Tasks (3.x - 5.x)** - Will consume generated TableDefinition objects
- **Task 6.1** (Database Class Integration) - Will use generated definitions for auto-migration

## Notes

### Implementation Decisions

1. **assertClause instead of assert:** This naming choice maintains API clarity while avoiding Dart keyword conflicts. Developers will understand this generates an ASSERT clause in SurrealQL.

2. **Const Constructors:** Following immutable value object pattern enables compile-time annotation evaluation and improves performance.

3. **SharedPartBuilder:** Using SharedPartBuilder rather than PartBuilder allows for future extensibility if we need multiple generators for the same source files.

4. **Early Validation:** Validating table names and field requirements at generation time provides immediate developer feedback rather than runtime errors.

### Testing Strategy

The 11 tests focus on annotation functionality rather than code generation output. This is intentional - code generation tests will be added in Task 1.2 when the type mapper is complete and we can verify the actual generated .surreal.dart files.

### Future Enhancements

While this task implements the foundation, several enhancements are planned for later tasks:
- Type expression generation (Task 1.2)
- Default value expression generation (Task 1.2)
- Vector dimension validation (Task 2.2)
- ASSERT clause formatting (Task 2.2)
- INDEX definition generation (Task 2.2)
