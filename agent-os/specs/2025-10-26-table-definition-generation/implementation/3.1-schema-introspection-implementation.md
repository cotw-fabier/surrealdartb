# Task 3.1: Schema Introspection

## Overview
**Task Reference:** Task #3.1 from `agent-os/specs/2025-10-26-table-definition-generation/tasks.md`
**Implemented By:** api-engineer
**Date:** 2025-10-26
**Status:** ✅ Complete

### Task Description
Implement schema introspection functionality to query and parse the current database schema using SurrealDB's INFO FOR DB and INFO FOR TABLE queries. Build structured data representations (DatabaseSchema, TableSchema, FieldSchema, IndexSchema) to capture the complete database schema state for migration detection and diff calculation.

## Implementation Summary

The schema introspection system provides a complete solution for discovering and representing the current state of a SurrealDB database schema. The implementation executes INFO FOR DB and INFO FOR TABLE queries, parses their JSON responses, and builds strongly-typed snapshot classes that accurately represent tables, fields, indexes, and constraints.

The system is designed to be stateless and repeatable - introspection can be run at any time to get a fresh snapshot of the database state. This enables the migration system to detect schema drift by comparing code-defined schemas with the live database schema. The implementation follows existing patterns from the codebase, reusing the Database.query() method and extending the DatabaseException hierarchy for error handling.

## Files Changed/Created

### New Files
- `lib/src/schema/introspection.dart` - Core introspection module with DatabaseSchema, TableSchema, FieldSchema, and IndexSchema classes
- `test/schema_introspection_test.dart` - Comprehensive test suite with 8 tests covering all introspection functionality

### Modified Files
- `lib/src/exceptions.dart` - Added SchemaIntrospectionException to the exception hierarchy
- `lib/surrealdartb.dart` - Exported introspection classes (DatabaseSchema, TableSchema, FieldSchema, IndexSchema) and SchemaIntrospectionException to public API

### Deleted Files
None

## Key Implementation Details

### DatabaseSchema Class
**Location:** `lib/src/schema/introspection.dart`

The DatabaseSchema class represents a complete snapshot of the database schema at a point in time. It contains:

- **tables**: Map of table names to TableSchema objects
- **introspect()**: Static async method that executes INFO FOR DB and builds the snapshot
- **toJson()/fromJson()**: Serialization support for storing snapshots (e.g., in migration history)
- Helper methods: hasTable(), getTable(), tableNames

The introspect() method executes INFO FOR DB to get all table names, then iterates through each table calling TableSchema.introspect() to build complete table metadata. This two-phase approach ensures we capture all table details.

**Rationale:** A complete database snapshot is needed for migration detection. By capturing the entire schema state in a structured format, we can compare code-defined schemas with the database state to detect changes. Serialization support enables storing snapshots in migration history for rollback functionality.

### TableSchema Class
**Location:** `lib/src/schema/introspection.dart`

The TableSchema class represents a single table's schema including:

- **name**: The table name
- **fields**: Map of field names to FieldSchema objects
- **indexes**: Map of index names to IndexSchema objects
- **introspect()**: Static async method that executes INFO FOR TABLE and parses the response
- Helper methods: hasField(), getField(), hasIndex(), getIndex()

The introspect() method executes INFO FOR TABLE [tableName] and parses the returned JSON structure to extract field and index definitions. The SurrealDB response format includes 'fields' and 'indexes' keys with nested definition strings that are parsed by FieldSchema.parse() and IndexSchema.parse().

**Rationale:** Tables are the core organizational unit in database schemas. Capturing complete table metadata including all fields and indexes enables accurate schema comparison and migration generation.

### FieldSchema Class
**Location:** `lib/src/schema/introspection.dart`

The FieldSchema class represents a field's schema including:

- **name**: Field name
- **type**: Field type string (e.g., 'string', 'int', 'float', 'bool')
- **optional**: Whether the field is optional (can be null)
- **assertClause**: Optional ASSERT validation expression
- **defaultValue**: Optional default value
- **parse()**: Static factory that parses SurrealDB field definition strings

The parse() method handles the SurrealDB DEFINE FIELD statement format:
```
DEFINE FIELD name ON table TYPE type [ASSERT ...] [DEFAULT ...]
```

It extracts the type, detects option<T> for optional fields, extracts ASSERT clauses, and parses default values. The parser uses regex matching to handle the various formats SurrealDB returns.

**Rationale:** Field-level schema information is essential for detecting changes like type modifications, new/removed fields, and constraint changes. The parser handles the variability in SurrealDB's DEFINE FIELD syntax while building a normalized representation.

### IndexSchema Class
**Location:** `lib/src/schema/introspection.dart`

The IndexSchema class represents an index definition:

- **name**: Index name
- **fields**: List of field names that are indexed
- **parse()**: Static factory that parses SurrealDB index definition strings
- Helper methods: isComposite (multi-field), includesField()

The parse() method handles the SurrealDB DEFINE INDEX statement format:
```
DEFINE INDEX name ON table FIELDS field1, field2, ...
```

It extracts the comma-separated field list to support both single-field and composite indexes.

**Rationale:** Index definitions are part of the schema and need to be tracked for migration purposes. Changes to indexes (additions/removals) are generally safe operations but should be tracked in migration history.

### SchemaIntrospectionException
**Location:** `lib/src/exceptions.dart`

A new exception type extending DatabaseException:

```dart
class SchemaIntrospectionException extends DatabaseException {
  SchemaIntrospectionException(
    super.message, {
    super.errorCode,
    super.nativeStackTrace,
  });
}
```

This exception is thrown when:
- INFO FOR DB returns no results
- INFO FOR TABLE returns no results
- Parsing of schema definitions fails
- Individual table introspection fails

**Rationale:** Following the existing exception pattern, we extend DatabaseException to provide specific error context for schema introspection failures. This enables code to catch introspection-specific errors separately from general database errors.

## Database Changes (if applicable)

### Migrations
None - This is a read-only introspection system that queries existing schema information.

### Schema Impact
None - No schema changes are made by the introspection system.

## Dependencies (if applicable)

### New Dependencies Added
None - Uses only existing packages (dart:convert for JSON parsing).

### Configuration Changes
None - All functionality uses existing Database.query() infrastructure.

## Testing

### Test Files Created/Updated
- `test/schema_introspection_test.dart` - 8 comprehensive tests covering all introspection functionality

### Test Coverage
- Unit tests: ✅ Complete
- Integration tests: ✅ Complete (tests use real in-memory SurrealDB)
- Edge cases covered:
  - Empty database (no tables defined)
  - Tables with various field types (string, int, float, bool, datetime)
  - Tables with indexes
  - Tables with ASSERT clauses
  - Tables with optional fields (option<T>)
  - INFO FOR DB query execution
  - INFO FOR TABLE query execution
  - Schema response parsing

### Manual Testing Performed
All 8 tests executed successfully:

```
Test Results:
3.1.1 - INFO FOR DB query executes successfully ✓
3.1.2 - INFO FOR DB returns table definitions ✓
3.1.3 - INFO FOR TABLE returns field metadata ✓
3.1.4 - Parse field type information ✓
3.1.5 - Parse index definitions ✓
3.1.6 - Handle empty database schema ✓
3.1.7 - Handle table with ASSERT clauses ✓
3.1.8 - Handle optional and required fields ✓

All 8 tests passed in ~7 seconds
```

The tests verify:
1. INFO FOR DB executes and returns valid schema information
2. Table definitions are correctly extracted from INFO FOR DB response
3. Field metadata is correctly extracted from INFO FOR TABLE response
4. Field type information is correctly parsed from definition strings
5. Index definitions are correctly parsed and extracted
6. Empty databases are handled gracefully (no errors)
7. ASSERT clauses are preserved in FieldSchema
8. Optional vs required fields are correctly detected (option<T> syntax)

## User Standards & Preferences Compliance

### global/coding-style.md
**File Reference:** `agent-os/standards/global/coding-style.md`

**How Your Implementation Complies:**
All code follows Dart style conventions: camelCase for variables/methods, PascalCase for classes, descriptive names (DatabaseSchema, TableSchema, FieldSchema, IndexSchema), comprehensive dartdoc comments on all public APIs. The introspection module is organized with clear class hierarchies and separation of concerns.

**Deviations (if any):**
None

### global/error-handling.md
**File Reference:** `agent-os/standards/global/error-handling.md`

**How Your Implementation Complies:**
The implementation extends the existing DatabaseException hierarchy with SchemaIntrospectionException, following the established pattern. All error cases are explicitly handled with clear, actionable error messages. The introspect() methods wrap errors and rethrow with context. Failed operations provide diagnostic information about what went wrong during schema discovery.

**Deviations (if any):**
None

### backend/async-patterns.md
**File Reference:** `agent-os/standards/backend/async-patterns.md`

**How Your Implementation Complies:**
All introspection methods return Futures and use async/await properly. The introspect() static methods are async and await database query operations. The implementation reuses the existing Database.query() async infrastructure, ensuring consistent async behavior throughout the codebase.

**Deviations (if any):**
None

### global/conventions.md
**File Reference:** `agent-os/standards/global/conventions.md`

**How Your Implementation Complies:**
File structure follows conventions (lib/src/schema/introspection.dart for implementation, test/schema_introspection_test.dart for tests). Class naming is clear and descriptive. The implementation follows the established pattern of having parse() factory methods for parsing external formats, similar to json_serializable patterns. Serialization uses toJson()/fromJson() naming consistent with the rest of the codebase.

**Deviations (if any):**
None

### testing/test-writing.md
**File Reference:** `agent-os/standards/testing/test-writing.md`

**How Your Implementation Complies:**
Tests are organized in a group structure with clear test names. Each test validates a single concern (INFO FOR DB execution, table extraction, field parsing, etc.). Tests use setUp/tearDown for proper database lifecycle management. All tests are deterministic and use in-memory databases for fast execution. Test count (8 tests) falls within the specified 2-8 focused tests guideline.

**Deviations (if any):**
None

## Integration Points (if applicable)

### APIs/Endpoints
- **DatabaseSchema.introspect(Database db)** - Queries database schema using INFO FOR DB
  - Request: Executes `INFO FOR DB` query via Database.query()
  - Response: Returns DatabaseSchema snapshot with all tables

- **TableSchema.introspect(Database db, String tableName)** - Queries table schema using INFO FOR TABLE
  - Request: Executes `INFO FOR TABLE [tableName]` query via Database.query()
  - Response: Returns TableSchema with fields and indexes

### External Services
None - Uses only internal Database.query() method

### Internal Dependencies
- `Database.query()` - Used to execute INFO FOR DB and INFO FOR TABLE queries
- `DatabaseException` - Exception hierarchy for error handling
- `Response.getResults()` - Used to extract query results

## Known Issues & Limitations

### Issues
None currently identified

### Limitations
1. **SurrealDB Response Format Dependency**
   - Description: Parser depends on specific DEFINE FIELD/INDEX string formats from SurrealDB
   - Reason: INFO FOR DB/TABLE responses use string representations, not structured JSON
   - Future Consideration: May need to handle format variations across SurrealDB versions. The regex-based parser is designed to be flexible but may need updates if SurrealDB changes output format.

2. **Basic Default Value Parsing**
   - Description: Default value parsing handles common cases (booleans, numbers, strings) but complex expressions may not parse fully
   - Reason: Default values can be any SurrealQL expression, which is difficult to parse comprehensively
   - Future Consideration: Could enhance parser to handle more complex default expressions if needed

## Performance Considerations

The introspection system executes one query per table (INFO FOR TABLE) plus one INFO FOR DB query. For databases with many tables (e.g., 100+ tables), this could result in 100+ queries. Performance optimization strategies:

- Schema snapshots can be cached in memory during migration detection
- Introspection only runs when needed (e.g., during database connection or manual migration)
- Queries are executed sequentially to avoid overwhelming the database
- In-memory databases (used for testing) complete introspection in milliseconds

For production use with large schemas, consider adding parallelization of INFO FOR TABLE queries if performance becomes an issue.

## Security Considerations

The introspection system is read-only and doesn't modify any data. It queries schema metadata using standard SurrealDB queries. No security concerns identified as:

- No user input is accepted directly (table names come from INFO FOR DB response)
- No data is written to the database
- All operations go through existing Database.query() which handles connection security

## Dependencies for Other Tasks

This implementation is a dependency for:
- **Task 3.2: Schema Diff Calculation** - Will use DatabaseSchema snapshots to compare current database state with code-defined schemas
- **Task 4.2: Transaction-Based Migration Execution** - Will use schema snapshots for migration history and rollback
- **Task 5.2: Manual Rollback Support** - Will use serialized DatabaseSchema snapshots stored in migration history

## Notes

The introspection implementation successfully provides a complete, stateless view of the database schema. The structured representation (DatabaseSchema → TableSchema → FieldSchema/IndexSchema) creates a clear hierarchy that mirrors the database structure and enables accurate schema comparison.

Key design decisions:
1. **Two-phase introspection**: INFO FOR DB first, then INFO FOR TABLE for each table. This ensures complete table metadata is captured.
2. **Parse-based approach**: Field and index definitions are parsed from string representations rather than structured JSON. This handles SurrealDB's current INFO output format.
3. **Serialization support**: toJson/fromJson enables storing snapshots for migration history and rollback.
4. **Static factory methods**: introspect() is static, creating snapshots without modifying class state.

The system is ready for integration with the schema diff calculation system (Task 3.2), which will compare these snapshots with code-defined TableStructure instances to detect schema changes.
