# Phase 4.2 Bug Fixes - Migration Execution

## Context

Task Group 4.2 (Transaction-Based Migration Execution) is partially complete with core infrastructure working but 5 out of 8 tests failing due to edge case bugs.

**Current Status:**
- ✅ 3/8 tests passing (migration history recording, destructive blocking)
- ❌ 5/8 tests failing (dry run, reports, rollback scenarios)
- Infrastructure complete, bugs are fixable edge cases

## Bugs to Fix

### Bug 1: Dry Run Mode Commits Instead of Rolling Back
**File:** `lib/src/schema/migration_engine.dart`
**Issue:** When `dryRun: true`, the transaction commits changes instead of canceling
**Expected:** Transaction should be canceled with `CANCEL TRANSACTION` to preview without applying
**Impact:** Dry run actually applies migrations (defeats the purpose)

### Bug 2: Report Structure Returns Null Fields
**File:** `lib/src/schema/migration_engine.dart`
**Issue:** MigrationReport returns null for some fields instead of populated data
**Expected:** Report should contain complete information about changes
**Impact:** Developers can't see what migrations will do

### Bug 3: _migrations System Table Not Filtered
**File:** `lib/src/schema/diff_engine.dart` or `migration_engine.dart`
**Issue:** The `_migrations` table appears in schema diffs as a change
**Expected:** System tables (starting with `_`) should be filtered from diffs
**Impact:** Every migration tries to remove the _migrations table

### Bug 4: Failed Migration Rollback Test Failing
**File:** `test/migration_execution_test.dart` and `lib/src/schema/migration_engine.dart`
**Issue:** Test expects automatic rollback on migration failure but it's not triggering
**Expected:** When migration fails, transaction should auto-rollback
**Impact:** Failed migrations might leave database in inconsistent state

### Bug 5: Migration Verification After Execution
**File:** `lib/src/schema/migration_engine.dart`
**Issue:** Post-migration verification may not be working correctly
**Expected:** After migration, verify schema matches expected state
**Impact:** Silent failures where migration claims success but didn't work

## Test File

**Location:** `/Users/fabier/Documents/code/surrealdartb/test/migration_execution_test.dart`

**Failing Tests:**
1. `test('Dry run mode previews without applying changes', ...)`
2. `test('Generate complete migration report', ...)`
3. `test('Failed migration triggers automatic rollback', ...)`
4. Potentially 2 more related to the above issues

## Success Criteria

- ✅ All 8 tests in `test/migration_execution_test.dart` pass
- ✅ Dry run mode properly cancels transactions
- ✅ MigrationReport contains complete change information
- ✅ System tables filtered from diffs
- ✅ Failed migrations automatically roll back
- ✅ No regressions in other test files (90 tests from Phases 1-4.1)

## Files to Focus On

1. **Primary:** `lib/src/schema/migration_engine.dart` - Most bugs likely here
2. **Secondary:** `lib/src/schema/diff_engine.dart` - System table filtering
3. **Test File:** `test/migration_execution_test.dart` - Verify fixes work

## Implementation Notes

- Transaction handling uses `Database.transaction()` method
- Dry run should use `CANCEL TRANSACTION` at the end
- System tables start with underscore (`_migrations`, `_functions`, etc.)
- MigrationReport structure defined in migration_engine.dart
- Error handling uses MigrationException from exceptions.dart

## Estimated Effort

**4-7 hours** based on complexity assessment. These are edge case bugs in otherwise working infrastructure.
