# Task 1.1: Core Type Definitions

## Overview
**Task Reference:** Task #1.1 from `agent-os/specs/2025-10-21-sdk-parity/tasks.md`
**Implemented By:** api-engineer
**Date:** 2025-10-21
**Status:** ✅ Complete

### Task Description
Implement core SurrealDB type definitions including RecordId, Datetime, SurrealDuration, and PatchOp classes. These types provide Dart representations of SurrealDB-specific data types with proper serialization/deserialization for FFI transport.

## Implementation Summary
Successfully implemented all four core type definitions following existing patterns in the codebase. Each type includes:
- Proper validation and error handling
- JSON serialization for FFI transport
- Conversion to/from Dart native types where applicable
- Comprehensive documentation with usage examples

All types follow Dart null safety best practices and use final-by-default approach. Implemented 15 focused unit tests covering critical conversion paths (RecordId parsing, Datetime conversion, Duration parsing, and PatchOp JSON serialization), and all tests pass successfully.

## Files Changed/Created

### New Files
- `lib/src/types/record_id.dart` - RecordId class for table:id identifiers with parsing and validation
- `lib/src/types/datetime.dart` - Datetime wrapper for SurrealDB datetime with ISO 8601 serialization
- `lib/src/types/duration.dart` - SurrealDuration class supporting SurrealDB duration syntax (2h30m, etc.)
- `lib/src/types/patch_op.dart` - PatchOp class for JSON Patch operations (RFC 6902)
- `lib/src/types/types.dart` - Index file exporting all type definitions
- `test/unit/core_types_test.dart` - Unit tests for all core type definitions (15 tests)

### Modified Files
- `lib/surrealdartb.dart` - Added export of new types (RecordId, Datetime, SurrealDuration, PatchOp, PatchOperation)

### Deleted Files
None

## Key Implementation Details

### RecordId Class
**Location:** `lib/src/types/record_id.dart`

Implemented a complete RecordId class that represents SurrealDB's table:id format. Key features:
- Constructor validates table names using regex pattern (alphanumeric, underscore, starts with letter/underscore)
- Supports both string and numeric IDs (int and double)
- `parse()` factory method parses "table:id" strings, automatically converting numeric strings to numbers
- `fromJson()` factory accepts both string format and map format
- `toJson()` serializes to standard "table:id" string format
- Equality and hashCode implemented for proper comparison

**Rationale:** This implementation ensures type safety and validation at the API boundary, preventing invalid record IDs from reaching the FFI layer. The dual constructor/factory pattern follows Dart conventions and provides flexibility for different use cases.

### Datetime Class
**Location:** `lib/src/types/datetime.dart`

Implemented a Datetime wrapper around Dart's DateTime with SurrealDB-compatible serialization:
- Wraps standard Dart DateTime for easy interop
- `parse()` factory uses DateTime.parse for ISO 8601 string parsing
- `toDateTime()` provides conversion back to Dart DateTime
- `toIso8601String()` and `toJson()` serialize to ISO 8601 format
- Equality and hashCode based on underlying DateTime

**Rationale:** While Dart has a built-in DateTime, SurrealDB requires specific ISO 8601 serialization for FFI transport. This wrapper ensures consistent formatting while maintaining easy conversion to/from Dart's native DateTime type.

### SurrealDuration Class
**Location:** `lib/src/types/duration.dart`

Implemented a comprehensive duration parser supporting SurrealDB's flexible syntax:
- Named SurrealDuration to avoid conflict with Dart's Duration class
- Supports units: ns, us/µs, ms, s, m, h, d, w
- `parse()` uses regex to extract value-unit pairs and converts to microseconds
- `toString()` outputs compact format using largest appropriate units
- `toDuration()` converts to Dart Duration
- Handles complex formats like "1w3d5h30m15s"

**Rationale:** SurrealDB's duration syntax is more flexible than standard ISO 8601 durations. The implementation uses regex pattern matching to parse multiple unit specifications and intelligently formats output using the largest appropriate units for readability.

### PatchOp Class
**Location:** `lib/src/types/patch_op.dart`

Implemented JSON Patch operations following RFC 6902 with SurrealDB extensions:
- Enum for operation types: add, remove, replace, change
- Static factory methods for each operation type
- Path validation ensures JSON Pointer format (starts with '/')
- `toJson()` serializes to RFC 6902 format
- Remove operation correctly omits value field

**Rationale:** The static factory pattern (PatchOp.add(), PatchOp.remove(), etc.) provides a clean, type-safe API that prevents common errors like forgetting to include a value for add/replace operations or including a value for remove operations.

## Database Changes (if applicable)
N/A - No database schema changes required for type definitions.

## Dependencies (if applicable)

### New Dependencies Added
None - All implementations use only Dart standard library.

### Configuration Changes
None

## Testing

### Test Files Created/Updated
- `test/unit/core_types_test.dart` - Created with 15 focused unit tests

### Test Coverage
- Unit tests: ✅ Complete
- Integration tests: ⚠️ Not applicable (pure type definitions)
- Edge cases covered:
  - RecordId: Empty table names, invalid table formats, numeric ID parsing, JSON serialization
  - Datetime: ISO 8601 parsing, round-trip conversion, JSON serialization
  - SurrealDuration: Simple formats (2h30m), complex formats (1w3d5h), conversion from Dart Duration
  - PatchOp: All operation types, path validation, JSON format compliance

### Manual Testing Performed
Ran the test suite using `dart test test/unit/core_types_test.dart`. All 15 tests passed:
- 4 tests for RecordId
- 3 tests for Datetime
- 4 tests for SurrealDuration
- 4 tests for PatchOp

Test execution completed in <1 second with 100% success rate.

## User Standards & Preferences Compliance

### Dart Coding Style Standards
**File Reference:** `agent-os/standards/global/coding-style.md`

**How Your Implementation Complies:**
All code follows Effective Dart guidelines with PascalCase for classes (RecordId, Datetime, SurrealDuration, PatchOp), camelCase for methods and variables, and snake_case for file names. Used arrow syntax for simple one-line methods, marked all variables as final, and kept functions focused and under 20 lines where possible. All types include comprehensive dartdoc documentation.

**Deviations (if any):**
None

---

### FFI Type Mapping Standards
**File Reference:** `agent-os/standards/backend/ffi-types.md`

**How Your Implementation Complies:**
All types serialize to JSON strings or maps for FFI transport, following the JSON serialization pattern established in the codebase. The toJson() methods on all classes ensure proper conversion for FFI boundary crossing. No direct pointer manipulation is exposed in the public API.

**Deviations (if any):**
None

---

### Error Handling Standards
**File Reference:** `agent-os/standards/global/error-handling.md`

**How Your Implementation Complies:**
All validation throws ArgumentError or FormatException with clear, descriptive messages. For example, RecordId validates table names and throws ArgumentError with detailed explanation of the expected format. Datetime.parse() and SurrealDuration.parse() throw FormatException for invalid input strings, preserving stack traces and providing context.

**Deviations (if any):**
None

---

### Validation Standards
**File Reference:** `agent-os/standards/global/validation.md`

**How Your Implementation Complies:**
All inputs are validated at API boundaries before processing. RecordId validates table names with regex pattern and ID types. PatchOp validates path format ensuring JSON Pointer compliance. Datetime and SurrealDuration validate string formats during parsing. Null checks are performed where required, and clear error messages guide developers on correct usage.

**Deviations (if any):**
None

---

### Conventions Standards
**File Reference:** `agent-os/standards/global/conventions.md`

**How Your Implementation Complies:**
Followed standard Dart package layout with types in lib/src/types/ and exported through lib/surrealdartb.dart. All code is soundly null-safe. Used final for all variables that don't need reassignment. Documentation includes examples and clear descriptions of behavior.

**Deviations (if any):**
None

## Integration Points (if applicable)

### APIs/Endpoints
These types will be used by:
- `db.insert().relation()` - Uses RecordId for in/out fields
- `db.upsert().patch()` - Uses PatchOp for JSON patch operations
- Future authentication methods - Will use Datetime for token expiry
- Query parameters - Will use SurrealDuration for timeout values

### Internal Dependencies
- All types exported through main library file (`lib/surrealdartb.dart`)
- Types are independent and don't depend on each other
- Will be used by future CRUD operations (insert, upsert, get)

## Known Issues & Limitations

### Issues
None

### Limitations
1. **SurrealDuration Nanosecond Precision**
   - Description: Dart Duration only supports microsecond precision, while SurrealDB supports nanoseconds
   - Reason: Dart's Duration limitation
   - Future Consideration: Could be addressed by storing nanoseconds separately if needed for high-precision use cases

2. **RecordId Validation**
   - Description: Basic regex validation for table names may not catch all invalid SurrealDB identifiers
   - Reason: Simple implementation for initial version
   - Future Consideration: Could be enhanced with more comprehensive SurrealDB identifier validation if needed

## Performance Considerations
All type conversions and validations have O(1) or O(n) complexity where n is string length. SurrealDuration.parse() uses regex which is efficient for typical duration strings. No performance concerns identified for expected usage patterns.

## Security Considerations
- RecordId validates table names to prevent injection attacks through malformed identifiers
- PatchOp validates path format to ensure JSON Pointer compliance
- All types throw descriptive exceptions rather than failing silently, making security issues easier to detect

## Dependencies for Other Tasks
- Task 2.1 (Insert Operations): Depends on RecordId for relation fields
- Task 2.2 (Upsert Operations): Depends on PatchOp for patch variant
- Task 1.2 (Authentication Types): May use Datetime for token expiry
- Task 4.1 (Parameter Management): May use SurrealDuration for duration parameters

## Notes
- Chose to name the duration class "SurrealDuration" rather than just "Duration" to avoid namespace conflicts with Dart's built-in Duration class, making the API more explicit and avoiding import confusion
- PatchOp uses an enum for operations rather than strings to provide compile-time type safety
- All types implement equality and hashCode for proper comparison and use in collections
- Comprehensive documentation with examples makes these types immediately usable by other developers
