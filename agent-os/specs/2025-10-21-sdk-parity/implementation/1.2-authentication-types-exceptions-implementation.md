# Task 1.2: Authentication Types & Exceptions

## Overview
**Task Reference:** Task #1.2 from `/Users/fabier/Documents/code/surrealdartb/agent-os/specs/2025-10-21-sdk-parity/tasks.md`
**Implemented By:** api-engineer
**Date:** 2025-10-21
**Status:** ✅ Complete

### Task Description
This task implements the authentication type system and exception hierarchy for the SurrealDB Dart SDK. It includes JWT token wrapping, a complete credentials hierarchy for different authentication levels, a notification class for live queries, and five new exception types to support advanced database operations.

## Implementation Summary
Successfully implemented a comprehensive authentication and notification type system with a robust exception hierarchy. The implementation provides type-safe credential handling at five different levels (root, namespace, database, scope, and record), secure JWT token wrapping, and a generic notification class for live query support. Additionally, five new exception types were added to handle transaction failures, live query errors, parameter operations, and data import/export failures. All components follow established patterns from the existing codebase and include complete serialization support for FFI transport. Eight focused unit tests verify all critical type behaviors and serialization paths.

## Files Changed/Created

### New Files
- `/Users/fabier/Documents/code/surrealdartb/lib/src/types/jwt.dart` - JWT token wrapper with secure access methods and serialization support
- `/Users/fabier/Documents/code/surrealdartb/lib/src/types/credentials.dart` - Complete credentials hierarchy including base class and five concrete credential types
- `/Users/fabier/Documents/code/surrealdartb/lib/src/types/notification.dart` - Generic notification class for live query events with action enum
- `/Users/fabier/Documents/code/surrealdartb/test/unit/auth_types_test.dart` - Comprehensive unit tests covering all authentication types and exceptions

### Modified Files
- `/Users/fabier/Documents/code/surrealdartb/lib/src/types/types.dart` - Updated barrel file to export new authentication and notification types
- `/Users/fabier/Documents/code/surrealdartb/lib/surrealdartb.dart` - Updated public API exports to include new types and exceptions
- `/Users/fabier/Documents/code/surrealdartb/lib/src/exceptions.dart` - Added five new exception types with consistent message formatting
- `/Users/fabier/Documents/code/surrealdartb/agent-os/specs/2025-10-21-sdk-parity/tasks.md` - Marked all Task 1.2 subtasks as complete

## Key Implementation Details

### JWT Wrapper Class
**Location:** `/Users/fabier/Documents/code/surrealdartb/lib/src/types/jwt.dart`

The JWT class provides a type-safe wrapper around JWT token strings with intentional security considerations. The token is stored in a private field `_token` to prevent accidental exposure in logs or debugging output. Access to the raw token requires explicitly calling `asInsecureToken()`, which has a method name that makes it clear the token is being exposed.

The class includes:
- Private token storage with explicit access method
- JSON serialization/deserialization for FFI transport
- Equality operators and hashCode for proper value semantics
- toString() that hides the token value for security

**Rationale:** The explicit "Insecure" naming in the access method follows security best practices by making developers consciously aware when they're exposing sensitive data. This pattern prevents accidental token leaks while still providing necessary access for authentication operations.

### Credentials Hierarchy
**Location:** `/Users/fabier/Documents/code/surrealdartb/lib/src/types/credentials.dart`

Implemented a complete hierarchy with an abstract base class and five concrete credential types:

1. **Credentials (base)** - Abstract class defining the `toJson()` contract
2. **RootCredentials** - Full administrative access with username/password
3. **NamespaceCredentials** - Namespace-level access with username/password/namespace
4. **DatabaseCredentials** - Database-level access with username/password/namespace/database
5. **ScopeCredentials** - Scope-based authentication with namespace/database/scope and dynamic params
6. **RecordCredentials** - Record-level authentication with namespace/database/access and dynamic params

Each class:
- Extends the base Credentials class
- Implements toJson() for FFI serialization
- Includes proper equality operators and hashCode
- Has clear toString() representations (hiding sensitive password data)
- Validates its specific authentication context

**Rationale:** This hierarchy mirrors SurrealDB's authentication levels and provides compile-time type safety. The use of abstract base class ensures all credentials can be handled polymorphically while maintaining type information for specific authentication methods.

### Notification Class
**Location:** `/Users/fabier/Documents/code/surrealdartb/lib/src/types/notification.dart`

The Notification class is a generic container for live query events with the following components:

- **NotificationAction enum** - Three action types: create, update, delete
- **Generic type parameter T** - Allows type-safe data handling
- **Properties** - queryId (String), action (enum), data (T)
- **Factory constructor** - Deserializes from JSON with custom deserializer function

The fromJson factory accepts a deserializer function parameter to handle the generic data type, avoiding the limitations of Dart's type erasure at runtime.

**Rationale:** The generic type parameter enables type-safe live query streams (e.g., `Stream<Notification<Map<String, dynamic>>>`). The deserializer function pattern allows flexible data transformation while maintaining type safety.

### Exception Types
**Location:** `/Users/fabier/Documents/code/surrealdartb/lib/src/exceptions.dart`

Added five new exception types, all extending DatabaseException:

1. **TransactionException** - Transaction begin/commit/rollback failures
2. **LiveQueryException** - Live query subscription and streaming errors
3. **ParameterException** - Parameter set/unset operation failures
4. **ExportException** - Database export operation failures
5. **ImportException** - Database import operation failures

Each exception:
- Extends DatabaseException for consistent error handling
- Accepts message, optional errorCode, and optional nativeStackTrace
- Implements toString() with structured formatting
- Can be caught as DatabaseException or specific type

Also updated **AuthenticationException** documentation to reflect its actual usage (signin, signup, authenticate, invalidate operations).

**Rationale:** The consistent exception hierarchy allows both specific error handling (catch TransactionException) and general error handling (catch DatabaseException). The optional errorCode and nativeStackTrace preserve debugging context from the Rust FFI layer.

## Database Changes
Not applicable - This task implements type definitions and does not modify database schema.

## Dependencies
No new dependencies added. All implementations use only Dart standard library features.

## Testing

### Test Files Created/Updated
- `/Users/fabier/Documents/code/surrealdartb/test/unit/auth_types_test.dart` - 8 focused unit tests

### Test Coverage
- Unit tests: ✅ Complete
- Integration tests: ⚠️ Deferred (will be covered when authentication methods are implemented in Task 3.1)
- Edge cases covered:
  - JWT serialization round-trip
  - All credential type JSON serialization
  - Notification generic type handling
  - Notification action enum parsing (create/update/delete)
  - Exception message formatting with error codes
  - Exception inheritance hierarchy
  - Parameter map deep equality for ScopeCredentials and RecordCredentials

### Manual Testing Performed
Ran the authentication types test suite:

```bash
dart test test/unit/auth_types_test.dart
```

**Results:** All 8 tests passed successfully
- Test 1: JWT token wrapping and serialization ✅
- Test 2: RootCredentials JSON serialization ✅
- Test 3: NamespaceCredentials and DatabaseCredentials ✅
- Test 4: ScopeCredentials and RecordCredentials with params ✅
- Test 5: Notification with generic type parameter ✅
- Test 6: Notification deserialization from JSON ✅
- Test 7: Exception construction and message formatting ✅
- Test 8: All exception types extend DatabaseException ✅

## User Standards & Preferences Compliance

### Global Coding Style (/Users/fabier/Documents/code/surrealdartb/agent-os/standards/global/coding-style.md)
**How Implementation Complies:**
All Dart code follows the repository's established patterns including proper class organization, clear naming conventions, and comprehensive dartdoc comments. Each type includes usage examples in documentation comments. Code is formatted consistently with proper indentation and line length limits.

**Deviations:** None

### Global Commenting (/Users/fabier/Documents/code/surrealdartb/agent-os/standards/global/commenting.md)
**How Implementation Complies:**
Every public class, property, and method includes detailed dartdoc comments with descriptions and usage examples. Comments explain the "why" behind design decisions (e.g., JWT asInsecureToken naming, generic deserializer function parameter). Complex logic like params map equality includes inline comments.

**Deviations:** None

### Global Conventions (/Users/fabier/Documents/code/surrealdartb/agent-os/standards/global/conventions.md)
**How Implementation Complies:**
File naming follows snake_case (jwt.dart, credentials.dart, notification.dart). Class names are PascalCase. Method names are camelCase. All types are properly exported through barrel files (types.dart) following the established pattern. Import organization is clean with library-level documentation.

**Deviations:** None

### Global Error Handling (/Users/fabier/Documents/code/surrealdartb/agent-os/standards/global/error-handling.md)
**How Implementation Complies:**
All new exception types follow the existing DatabaseException pattern with message, errorCode, and nativeStackTrace fields. Exception constructors validate input (e.g., JWT.fromJson checks token is String, Notification.fromJson validates action enum). ArgumentError is thrown for invalid construction parameters with clear messages.

**Deviations:** None

### Global Validation (/Users/fabier/Documents/code/surrealdartb/agent-os/standards/global/validation.md)
**How Implementation Complies:**
Input validation is performed at construction time for all types. JWT.fromJson validates token is a String. Notification.fromJson validates queryId and action fields exist and have correct types. Invalid notification actions throw ArgumentError with descriptive messages. Credential classes accept dynamic types for params maps to support flexible authentication patterns while maintaining type safety at the API level.

**Deviations:** None

### Testing Standards (/Users/fabier/Documents/code/surrealdartb/agent-os/standards/testing/test-writing.md)
**How Implementation Complies:**
Eight focused unit tests cover critical type behaviors without over-testing. Tests are well-organized in a single test group with descriptive names. Each test focuses on one specific aspect (JWT serialization, credential JSON format, notification generics, exception hierarchy). Tests use proper assertions and follow the arrange-act-assert pattern. Test file location follows convention (test/unit/auth_types_test.dart).

**Deviations:** None

## Integration Points

### APIs/Endpoints
Not applicable - These are type definitions used by future API implementations.

### Internal Dependencies
These types will be used by:
- Authentication methods (Task 3.1) - Will use Jwt, Credentials hierarchy, and AuthenticationException
- Live query implementation (Task 6.1) - Will use Notification class and NotificationAction enum
- Transaction implementation (Task 7.1) - Will use TransactionException
- Parameter management (Task 4.1) - Will use ParameterException
- Data import/export (Task 5.1) - Will use ExportException and ImportException

## Known Issues & Limitations

### Issues
None identified.

### Limitations
1. **Embedded Mode Authentication**
   - Description: Authentication may have limited functionality in embedded mode compared to remote SurrealDB servers
   - Reason: Embedded database instances may not support all authentication features like token refresh or full scope-based access control
   - Future Consideration: Will be documented clearly in Task 3.1 when authentication methods are implemented

2. **Notification Deserializer Pattern**
   - Description: Notification.fromJson requires a deserializer function parameter due to Dart's type erasure
   - Reason: Cannot infer generic type T at runtime from JSON, so caller must provide transformation logic
   - Future Consideration: This is a Dart language limitation and the pattern is widely accepted. Could potentially provide convenience factories for common types (e.g., Notification.mapFromJson) in the future.

## Performance Considerations
All type classes are lightweight value objects with minimal overhead. JSON serialization uses Dart's built-in jsonEncode/jsonDecode which is optimized. Credential classes with params maps use deep equality comparison which could be O(n) for large params, but authentication params are typically small (<10 keys). No performance concerns identified for expected usage patterns.

## Security Considerations
**JWT Token Hiding:** The Jwt class intentionally hides the token value in toString() to prevent accidental logging of sensitive credentials. The asInsecureToken() method name makes it explicit when the token is being accessed, encouraging developers to handle it securely.

**Credentials toString():** All credential classes hide password values in their toString() representations to prevent accidental exposure in logs or debugging output.

**No Encryption at Rest:** These types do not provide encryption - tokens and credentials are stored in memory as plain text. It is the responsibility of the calling code to handle secure storage if needed.

## Dependencies for Other Tasks
- **Task 3.1 (Authentication Operations)** - BLOCKED until Rust FFI functions are implemented, but Dart types are ready
- **Task 6.1 (Live Query Infrastructure)** - Notification type is ready for use
- **Task 7.1 (Transaction Support)** - TransactionException is ready for use
- **Task 4.1 (Parameter Management)** - ParameterException is ready for use
- **Task 5.1 (Export and Import Operations)** - ExportException and ImportException are ready for use

## Notes

**Design Decision - Credentials Base Class:**
Chose abstract base class over interface to enforce the toJson() contract while allowing future shared functionality. This also enables polymorphic handling of credentials in method signatures (e.g., `Future<Jwt> signin(Credentials credentials)`).

**Design Decision - Notification Generic Type:**
The generic type parameter on Notification allows type-safe stream handling (e.g., `Stream<Notification<Person>>`) while the deserializer function handles the runtime transformation. This is superior to using dynamic or Object? as it provides compile-time type safety.

**Design Decision - Separate Exception Types:**
While all five new exceptions have similar structure, keeping them as separate types allows precise error handling and makes it clear what operation failed. This follows the principle of specific exceptions over generic error handling.

**Code Quality:**
All code passes Dart analysis with no warnings. Null safety is fully enforced. All public APIs are documented with dartdoc comments including usage examples.
